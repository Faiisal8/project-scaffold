import { getDb } from "../db/sqlite.js";

let startedAt: number | null = null;

export function setStartTime(time: number): void {
  startedAt = time;
}

export function getUptime(): string {
  if (!startedAt) {
    return "0s";
  }
  const seconds = Math.floor((Date.now() - startedAt) / 1000);
  return `${seconds}s`;
}

export async function checkHealth(): Promise<{ status: string; db: string; uptime: string; db_error?: string }> {
  const status = {
    status: "ok",
    db: "unknown" as string,
    uptime: getUptime(),
  };

  try {
    const db = getDb();
    db.prepare("SELECT 1").get();
    status.db = "up";
  } catch (error) {
    status.db = "down";
    status.db_error = error instanceof Error ? error.message : String(error);
  }

  return status;
}
